---
title: "EcoTaxa_New"
output: html_document
date: "2025-09-08"
---
#This markdown contains the code for loading the tsv files as well as making the biovolume line graphs. Biovolume is calculated using spherical volume from the provided ESD from Zoo Process and follows calulations provided by Hydroptic. Splitting fractions are input into an if/then pipeline to account for the multiple scans taken of each sample. All samples are strained through a seive with a mesh size matching the original net mesh to filter out zooplankton of inappropriate size fractions,

#Don't forget to load all of your packages first or it will not work lol I am just going to put all packages for all calculations in here so they can always be found
```{r load packages here, include=FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(viridis)
library(forcats) #RA
library(ggpattern)
library(gtable)
library(patchwork)
library(scales)
library(mgcv) #GAM
library(nlme) #GAM
library(tidyr) #RA
library(data.table) #NBSS only
```

#Importing and combining all EcoTaxa zip and TSV files between all necessary projects:
```{r import zip, include=FALSE}
library(dplyr)

# Define paths
zip_file <- "/Volumes/Seagate/EcoTaxa_Test/Ecotaxa.zip"
extracted_dir <- "path/to/R_Work/EcoTaxa_Test"  # <-- Replace with actual path

# Create output directory if needed
if (!dir.exists(extracted_dir)) {
  dir.create(extracted_dir, recursive = TRUE)
}

# Unzip the files
unzip(zip_file, exdir = extracted_dir)

# List .tsv files
tsv_files <- list.files(extracted_dir, pattern = "\\.tsv$", full.names = TRUE)

# Define columns to force as character
force_char_cols <- c("sample_ship", "sample_stationid")

# Read and coerce selected columns to character if they exist
tsv_data <- lapply(tsv_files, function(file) {
  df <- read.delim(file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  
  # Force listed columns to character if present
  for (col in force_char_cols) {
    if (col %in% names(df)) {
      df[[col]] <- as.character(df[[col]])
    }
  }

  df$source_file <- basename(file)  # Optional: tag rows with source file
  df
})

# Combine safely
combined_df_1 <- bind_rows(tsv_data)

# Detect duplicates using dplyr pipeline
duplicates_df <- combined_df_1 %>%
  group_by(across(everything())) %>%
  filter(n() > 1) %>%
  ungroup()

# Optionally, print how many duplicates found
cat("Number of duplicated rows:", nrow(duplicates_df), "\n")


#combined_df_1 <- combined_df_1[!duplicated(combined_df_1), ] #gets rif of exact duplicates
# View result
combined_df_1 <- combined_df_1[, !(names(combined_df_1) %in% c("acq_scan_comment", "source_file"))]
head(combined_df_1)
```
```{r debug tsv check, include=FALSE}
# Inspect number of columns and column names
tsv_data <- lapply(tsv_files, function(file) {
  df <- read.delim(file, header = TRUE, sep = "\t")
  list(
    file = file,
    ncol = ncol(df),
    colnames = colnames(df),
    data = df
  )
})

# Print column info for each file
for (item in tsv_data) {
  cat("File:", item$file, "\n")
  cat("Number of columns:", item$ncol, "\n")
  cat("Column names:", paste(item$colnames, collapse = ", "), "\n\n")
}

```
```{r import Aug-Sept zip, include=FALSE}
library(dplyr)

zip_file_2 <- "/Volumes/Seagate/Aug_Sept/Aug_Sept.zip"
extracted_dir_2 <- "EcoTaxa_Test/Aug_Sept"

# Create output directory if needed
if (!dir.exists(extracted_dir_2)) {
  dir.create(extracted_dir_2, recursive = TRUE)
}

# Unzip the files
unzip(zip_file_2, exdir = extracted_dir_2)

# List .tsv files (including subfolders just in case)
tsv_files_2 <- list.files(extracted_dir_2, pattern = "\\.tsv$", full.names = TRUE, recursive = TRUE)

# Define columns to force as character
force_char_cols <- c("sample_ship", "sample_stationid")

# Read and coerce selected columns
tsv_data_2 <- lapply(tsv_files_2, function(file) {
  cat("Reading:", file, "\n")
  df_2 <- read.delim(file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  
  for (col in force_char_cols) {
    if (col %in% names(df_2)) {
      df_2[[col]] <- as.character(df_2[[col]])
    }
  }
  
  return(df_2)
})

# Combine dataframes
combined_df_2 <- bind_rows(tsv_data_2)

# Optional: Remove exact duplicates
# combined_df_2 <- combined_df_2[!duplicated(combined_df_2), ]

# View result
head(combined_df_2) 

```
```{r combine both df together, include=FALSE}
combined_df <- rbind(combined_df_1, combined_df_2)
combined_df$object_date <- as.Date(combined_df$object_date)
# Replace the date and other incorrect metadata moving forward
combined_df$object_date[combined_df$object_date == as.Date("2024-01-24")] <- as.Date("2025-01-24")
combined_df$object_date[combined_df$object_date == as.Date("2024-11-26")] <- as.Date("2024-12-04")
combined_df$object_date[combined_df$object_date == as.Date("2024-02-05")] <- as.Date("2025-02-05")
combined_df$object_date[combined_df$object_date == as.Date("2024-03-12")] <- as.Date("2025-03-12")
combined_df$object_date[combined_df$object_date == as.Date("2024-08-01")] <- as.Date("2024-08-06")
#combined_df$sample_net_mesh[combined_df$sample_net_mesh == 1251846.9429999999702] <- 700
combined_df$sample_tot_vol[combined_df$sample_tot_vol == as.double("1251846.9429999999702")] <- as.double("1251846.943")
combined_df$acq_sub_part[combined_df$object_date == as.Date("2025-05-07") & as.double(combined_df$acq_sub_part) == 2] <- 32
combined_df$acq_sub_part[combined_df$object_date == as.Date("2025-04-22") & as.double(combined_df$acq_sub_part) == 1] <- 4
combined_df$acq_sub_part[combined_df$object_date == as.Date("2024-06-13") & as.double(combined_df$acq_sub_part) == 32] <- 64
combined_df$acq_sub_part[combined_df$object_date == as.Date("2024-07-30") & as.double(combined_df$acq_sub_part) == 32] <- 64
combined_df$acq_sub_part[combined_df$object_date == as.Date("2024-07-30") & as.double(combined_df$acq_sub_part) == 1] <- 2
combined_df$sample_tot_vol[combined_df$sample_tot_vol == 13099.126899999999296] <- 130099.13
combined_df$sample_stationid[combined_df$object_date == as.Date("2025-06-17") & c(combined_df$sample_stationid) == "wood" & as.double(combined_df$acq_sub_part) == 1] <- "ram"
combined_df$sample_tot_vol[combined_df$object_date == as.Date("2025-06-17") & as.double(combined_df$acq_sub_part) == 1] <- 89907.44935
combined_df$sample_stationid[combined_df$object_date == as.Date("2025-06-23") & c(combined_df$sample_stationid) == "ram" & as.double(combined_df$acq_sub_part) == 16] <- "wood"
combined_df$sample_tot_vol[combined_df$object_date == as.Date("2025-06-23") & as.double(combined_df$acq_sub_part) == 16] <- 119622.6233
combined_df$sample_net_mesh[combined_df$sample_net_mesh == 99999] <- 700
combined_df$sample_tot_vol[combined_df$sample_tot_vol == 99999.000000000000000] <- 1251846.943
combined_df$sample_stationid[is.na(combined_df$sample_stationid)] <- "ram"
#combined_df <- combined_df[!duplicated(combined_df), ] #gets rid of exact duplicates
head(combined_df)

# Get unique dates
unique_dates <- unique(combined_df$object_date)

# Count them
n_unique_dates <- length(unique_dates)

# Print the count
print(n_unique_dates)

# Print the unique dates
print(unique_dates)
rm(unique_dates) #girl please clear you're environment 
count_unique <- length(unique(combined_df$object_id))
print(count_unique)
rm(count_unique) #CLEAR IT 
#rm(count_unique_2) #CLEAR IT CLEAR IT CLEAR IT
```

#Defining variables, all of this code came from the EcoTaxa and EcoPart manuals
```{r Define, include=FALSE}
Area_mm2 <- (combined_df$object_area)*(combined_df$process_particle_pixel_size_mm)^2
Area_excluded_mm2 <- (combined_df$object_area_exc)*(combined_df$process_particle_pixel_size_mm)^2
Major_mm <- (combined_df$combined_df$object_major)*(combined_df$process_particle_pixel_size_mm)
Minor_mm <- (combined_df$object_minor)*(combined_df$process_particle_pixel_size_mm)
Volume <- (combined_df$sample_tot_vol)/(100^3) #converting to m^3 since the Google Sheet computes it in cm^3
```
#Put all biovolume calculations in this section:
#Test case for a few random dates and run biovolume code to see if it is using the correct splitting factor
```{r Plain Biovol, include=FALSE}
Radius_circle <- sqrt(Area_mm2/pi)
Spherical_Volume <- ((4/3)*pi*(((combined_df$object_esd/2)*combined_df$process_particle_pixel_size_mm)^3))/1000 #ESD in pixels to cm^3 divide by 1000 to convert to mL (vol 1 individual)
#Divided by 2 to get radius
Biovolume <- ((Spherical_Volume*(combined_df$acq_sub_part)) / (combined_df$sample_tot_vol/(100^3)))
```
```{r Plain Biovol dataframe, include=FALSE}

# Assuming combined_df already contains object_date and acq_sub_part
Biovolume_df <- data.frame(
  Biovolume = Biovolume,  # Replace this with your Biovolume vector
  Date = combined_df$object_date,  # Date from object_date column
  Fraction = combined_df$acq_sub_part, # Include acq_sub_part here
  Volume,
  Tow = combined_df$sample_net_mesh # Include sample_net_mesh here
 )

print(Biovolume_df)

n_unique_dates <- length(unique(combined_df$object_date))
print(n_unique_dates)
```
```{r aggregates all pre-adjusted biovols by dateI TIHNK THIS IS CORRECT CHECK W TRICIA, include=FALSE}
# Convert to Date format if needed
Biovolume_df$Date <- as.Date(Biovolume_df$Date)

# Assuming combined_df already contains object_date and acq_sub_part
Biovolume_df <- data.frame(
  Biovolume = Biovolume,  # Replace this with your Biovolume vector
  Date = combined_df$object_date,  # Date from object_date column
  Fraction = combined_df$acq_sub_part, # Include acq_sub_part here
  Volume = combined_df$sample_tot_vol,# Include sample_net_mesh here
  Spherical_volume = Spherical_Volume,
  Tow = combined_df$sample_net_mesh, # Include sample_net_mesh here
  Station = combined_df$sample_stationid, #Allow for selection of specific sampling sites
  object_id = combined_df$object_id,
  object_annotation_hierarchy = combined_df$object_annotation_hierarchy,
  object_annotation_category = combined_df$object_annotation_category, 
  Year = year(combined_df$object_date)
 )

print(Biovolume_df)

# Aggregate Biovolume by Date
#biovolume_by_date <- aggregate(Spherical_volume ~ Date, data = Biovolume_df, sum)
# View the result
#print(biovolume_by_date)

# Group by Date and keep relevant columns
biovolume_by_date <- Biovolume_df %>%
  filter(!grepl("^not-living>", object_annotation_hierarchy, #)) %>%
                object_annotation_category != "badfocus<other")) %>%
  group_by(Date, Fraction, Volume, Tow, Station, Year) %>%
  summarise(Biovolume_tot = sum(Spherical_volume), .groups = "drop")

# Add biovol_conc column
biovolume_by_date <- biovolume_by_date %>%
  mutate(
    biovol_conc = if_else( #biovol_conc is the adjusted biovolume showing the biovolume of a sample per unit volume of seawater
      Fraction == 1, #scanned the entire sample, skips conversion
      Biovolume_tot / (Volume / 1e6), #divides by the corrected volume
      (Biovolume_tot * (Fraction / 2)) / (Volume / 1e6) #divides splitting fraction by 2 since 2 scans of the same fraction were taken, essentially if 2 1/32 scans were taken then 2/32 = 1/16 (computes correction and then divides by corrected volume)
    )
  )
# Aggregate values for 2025-02-26 (one is a single comb jelly pulled out of the tow)
agg_row <- biovolume_by_date %>%
  filter(Date == as.Date("2025-02-26")) %>%
  summarise(
    Date = as.Date("2025-02-26"),
    Biovolume_tot = sum(Biovolume_tot, na.rm = TRUE),
    biovol_conc = sum(biovol_conc, na.rm = TRUE),
    Fraction = NA_real_,  # or maybe mean(Fraction), if it makes sense
    Volume = NA_real_,    # or sum(Volume), if appropriate
    Tow = first(Tow),
    Station = first(Station),
    .groups = "drop"
  )

# Remove original rows for that date and add the combined one and remove detritus
biovolume_by_date <- biovolume_by_date %>%
  filter(Date != as.Date("2025-02-26")
  ) %>%
  bind_rows(agg_row)
# View result
print(biovolume_by_date)
```

```{r Biovolume plots, include=FALSE}
# Plot for Tow = 200
biovolume_plot_200 <- ggplot(data = biovolume_by_date %>% filter(Tow %in% as.numeric(200), Station %in% c("ram", "ram_island", "nan", "NaN") ), aes(x = Date, y = biovol_conc)) +
  geom_line(color = "black", size = 0.75) +  # Thicker line with size = 1.5
  geom_point()+
  #geom_smooth()+
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    plot.title = element_text(size = 22, hjust = 0.5),
    panel.grid = element_blank(),  # Remove all grid lines
    axis.line = element_line(color = "black", size = 0.5)  # Add axis lines
  ) +
    scale_x_date(
    date_breaks = "1 month",       # Breaks at 1-month intervals
    date_labels = "%B"             # Labels months as abbreviated names (e.g., "Jan", "Feb", "Mar")
  ) +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 1)) +
  labs(
    title = NULL,
    x = "Date",
    y = expression("Biovolume (individuals" ~ m^{-3} * ")")
  ) +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.50))
# Plot for Tow = 700
biovolume_plot_700 <- ggplot(data = biovolume_by_date %>% filter(Tow == 700), aes(x = Date, y = biovol_conc)) +
  geom_line(color = "black", size = 1.5) +  # Thicker line with size = 1.5
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    plot.title = element_text(size = 22, hjust = 0.5),
    #panel.grid = element_blank(),  # Remove all grid lines
    axis.line = element_line(color = "black", size = 0.5)  # Add axis lines
  ) +
    scale_x_date(
    date_breaks = "1 month",       # Breaks at 1-month intervals
    date_labels = "%B"             # Labels months as abbreviated names (e.g., "Jan", "Feb", "Mar")
  ) +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 0.01)) +
  labs(
    title = NULL,
    x = "Date",
    y = expression("Biovolume (individuals" ~ mL^{-3} * ")")
  )

# Print both plots
print(biovolume_plot_200)
ggsave("biovolume_plot_200.png", plot = biovolume_plot_200, dpi = 300)
browseURL("biovolume_plot_200.png")
print(biovolume_plot_700)
```
```{r, base R 200 biovolume plot}
biovolume_200 <- biovolume_200[order(biovolume_200$Date), ]

# Filter data
biovolume_200 <- subset(
  biovolume_by_date,
  Tow == 200 & Station %in% c("ram", "ram_island", "nan", "NaN")
)
par(mar = c(5, 5, 2, 2))  # c(bottom, left, top, right)

# Set up the plotting area
plot(
  biovolume_200$Date, biovolume_200$biovol_conc,
  type = "l",                      # both points and lines
  #pch = 19,                        # solid circle points
  col = "black",
  lwd = 1.5,                       # line thickness
  xlab = "Date",
  ylab = expression("BioVolume (individuals" ~ m^{-3} * ")"),
  xaxt = "n",                      # suppress x-axis labels for custom formatting
  las = 1,                         # make y-axis labels horizontal
  cex.lab = 1.4,                   # axis title size
  cex.axis = 1.2,                  # tick label size
  main = NULL
)

# Generate monthly ticks
x_ticks <- seq(min(biovolume_200$Date), max(biovolume_200$Date), by = "month")
x_labels <- format(x_ticks, "%B")

# Manually add axis ticks (no labels yet)
axis(1, at = x_ticks, labels = FALSE)

# Add rotated labels at 45 degrees
text(
  x = x_ticks, y = par("usr")[3] - 0.05 * diff(par("usr")[3:4]),  # position just below x-axis
  labels = x_labels,
  srt = 45,              # rotation angle
  adj = 1,               # right alignment
  xpd = TRUE,            # allow drawing outside plot region
  cex = 0.8              # label size
)

# Draw box border
box()
```

```{r Biovolume plots 2024 and 2025 stacked to compare curves, include=FALSE}
# Plot for Tow = 200
biovolume_plot_200_24 <- ggplot(data = biovolume_by_date %>% filter(Tow %in% as.numeric(200), Station %in% c("ram", "ram_island", "nan", "NaN"), Year == c("2024")), aes(x = Date, y = biovol_conc)) +
  geom_line(color = "black", size = 0.75) +  # Thicker line with size = 1.5
  geom_point()+
  #geom_smooth()+
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    plot.title = element_text(size = 22, hjust = 0.5),
    panel.grid = element_blank(),  # Remove all grid lines
    axis.line = element_line(color = "black", size = 0.5)  # Add axis lines
  ) +
    scale_x_date(
    date_breaks = "1 month",       # Breaks at 1-month intervals
    date_labels = "%B"             # Labels months as abbreviated names (e.g., "Jan", "Feb", "Mar")
  ) +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 1)) +
  labs(
    title = NULL,
    x = "Date",
    y = expression("Biovolume (individuals" ~ m^{-3} * ")")
  ) +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.50))
# Print both plots
print(biovolume_plot_200_24)
# Plot for Tow = 200 2025
biovolume_plot_200_25 <- ggplot(data = biovolume_by_date %>% filter(Tow %in% as.numeric(200), Station %in% c("ram", "ram_island", "nan", "NaN"), Year == c("2025")), aes(x = Date, y = biovol_conc)) +
  geom_line(color = "black", size = 0.75) +  # Thicker line with size = 1.5
  geom_point()+
  #geom_smooth()+
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    plot.title = element_text(size = 22, hjust = 0.5),
    panel.grid = element_blank(),  # Remove all grid lines
    axis.line = element_line(color = "black", size = 0.5)  # Add axis lines
  ) +
    scale_x_date(
    date_breaks = "1 month",       # Breaks at 1-month intervals
    date_labels = "%B"             # Labels months as abbreviated names (e.g., "Jan", "Feb", "Mar")
  ) +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 1)) +
  labs(
    title = NULL,
    x = "Date",
    y = expression("Biovolume (individuals" ~ m^{-3} * ")")
  ) +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.50))
# Print both plots
stacked_biovolume <- biovolume_plot_200_24/biovolume_plot_200_25
                plot_layout(heights = c(1, 1))
print(stacked_biovolume)
```

