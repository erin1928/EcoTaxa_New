---
title: "Shannon Diversity"
author: "Erin Anderson"
date: "2025-11-02"
output: html_document
---

#Shannon Diversity Index Calculations
```{r calculating SD for each sample, include=FALSE}
sd_df <- object_counts_og_with_dates_no_detritus %>%
 mutate(
    Month = month(object_date),
    Season = case_when(
      Month %in% 1:3 ~ "Winter",
      Month %in% 4:6 ~ "Spring",
      Month %in% 7:9 ~ "Summer",
      Month %in% 10:12 ~ "Fall"
    )
  )
print(sd_df)

# First, calculate proportions within each sample
shannon_diversity <- sd_df %>%
  group_by(object_date) %>%
  summarise(
    shannon_index = -sum(
      (n_cor / sum(n_cor)) * log(n_cor / sum(n_cor))
    )
  )

print(shannon_diversity)

# Join with season info (assuming season is the same for each object_date)
shannon_with_season <- shannon_diversity %>%
  left_join(sd_df %>% select(object_date, Season, Month) %>% distinct(), by = "object_date") %>%
  mutate(Year = year(object_date))

# Plot Shannon diversity by season
sd_box_plot <- ggplot(
  shannon_with_season,
  aes(x = factor(Season, levels = c("Winter", "Spring", "Summer", "Fall")),
      y = shannon_index,
      fill = Season)
) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~ Year) +
  labs(
    title = "Shannon Diversity Index by Season",
    x = "Season",
    y = "Shannon Diversity Index"
  ) +
  scale_fill_manual(
    values = c(
      "Winter" = "#C77CFF",  
      "Spring" = "#7CAE00",  
      "Summer" = "#00BFC4",  
      "Fall"   = "#F8766D"  
    )
  ) +
  theme_minimal() +
  theme(legend.position = "right")

print(sd_box_plot)
ggsave("sd_box_plot.png", plot = sd_box_plot, dpi = 300)
browseURL("sd_box_plot.png")

# Plot Shannon diversity by month
sd_box_plot_month <- ggplot(shannon_with_season, 
                            aes(x = Month, y = shannon_index, fill = Season)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~ Year) +
  labs(title = "Shannon Diversity Index by Month",
       x = "Month",
       y = "Shannon Diversity Index") +
  scale_fill_manual(
    values = c(
      "Winter" = "#C77CFF",  
      "Spring" = "#7CAE00",  
      "Summer" = "#00BFC4",  
      "Fall"   = "#F8766D"  
    )
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_discrete(drop = TRUE)

print(sd_box_plot_month)
ggsave("sd_box_plot_month.png", plot = sd_box_plot_month, dpi = 300)
browseURL("sd_box_plot_month.png")

shannon_with_season$Season <- factor(shannon_with_season$Season, levels = c("Winter", "Spring", "Summer", "Fall"))
anova_model <- aov(shannon_index ~ Season, data = shannon_with_season)
summary(anova_model)
TukeyHSD(anova_model)

shannon_with_season$Month <- factor(shannon_with_season$Month, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"))
anova_model_2 <- aov(shannon_index ~ Month, data = shannon_with_season)
summary(anova_model_2)
TukeyHSD(anova_model_2) #Significance between Sept and May, p = 0.0380236

anova_model_3 <- aov(shannon_index ~ Month * Year, data = shannon_with_season)
summary(anova_model_3)
TukeyHSD(anova_model_3)
tukey_results <- TukeyHSD(anova_model_3)
# Combine all TukeyHSD results into one data frame
tukey_df <- do.call(rbind, lapply(tukey_results, as.data.frame))

# Add a column showing which factor each result came from
tukey_df$Term <- rep(names(tukey_results), times = sapply(tukey_results, nrow))

# Filter for significant results (p adj â‰¤ 0.05)
sig_tukey <- subset(tukey_df, `p adj` <= 0.05)

sig_tukey[order(sig_tukey$`p adj`), ]
```
#Let's make a biodiversity GAM
```{r making the GAM for 200 micron, include=FALSE}
#install.packages("mgcv")
#install.packages("nlme")
library(mgcv)
library(nlme)
library(dplyr)
library(lubridate)
library(ggplot2)
pca_gam <- pca_data_df %>%
  mutate(
    object_date = Date
  )
# Join with season info (assuming season is the same for each object_date)
shannon_with_season_gam <- shannon_diversity %>%
  left_join(pca_gam %>% select(object_date, avg_chl_a, Water_Temp_Avg, Salinity_Avg, Secchi.depth) %>% distinct(), by = "object_date") %>%
  mutate(Year = year(object_date), 
         Month = month(object_date), 
         Season = case_when(
      Month %in% 1:3 ~ "Winter",
      Month %in% 4:6 ~ "Spring",
      Month %in% 7:9 ~ "Summer",
      Month %in% 10:12 ~ "Fall"))

shannon_with_season_gam <- na.omit(shannon_with_season_gam)

# Fit model
gam_1 <- gam(shannon_index ~ s(avg_chl_a) + s(Water_Temp_Avg) + s(Salinity_Avg) +s(Secchi.depth) +s(Month), family = gaussian(), data = shannon_with_season_gam)

# Summary
summary(gam_1)

gam_2 <- gam(shannon_index ~ s(Water_Temp_Avg) + s(Secchi.depth), family = gaussian(), data = shannon_with_season_gam) #Second GAM with only the significant response variables
summary(gam_2)
# Plot
plot(gam_2, pages = 1, rug = TRUE)


# Diagnostics
gam.check(gam_1)


ggsave(
  filename = "shannon_loess_overlay.png",  # file name + extension
  plot = sd_box_plot_month +
    geom_smooth(
      data = shannon_with_season_gam,
      aes(x = as.numeric(Water_Temp_Avg), y = shannon_index, group = Year),
      method = "gam", se = FALSE, span = 0.7,
      color = "red", size = 1.2
    ) +
    theme(plot.margin = margin(5.5, 5.5, 5.5, 5.5, unit = "pt")),
  width = 10,    # width in inches
  height = 6,   # height in inches
  dpi = 300     # resolution
)

ggsave(
  filename = "shannon_loess_overlay_secchi.png",  # file name + extension
  plot = sd_box_plot_month +
    geom_smooth(
      data = shannon_with_season_gam,
      aes(x = as.numeric(Secchi.depth), y = shannon_index, group = Year),
     method = "gam", se = FALSE, span = 0.7,
      color = "red", linewidth = 1.2
    ) +
    theme(plot.margin = margin(5.5, 5.5, 5.5, 5.5, unit = "pt")),
  width = 10,    # width in inches
  height = 6,   # height in inches
  dpi = 300     # resolution
)
```

```{r remaking data tables for corrected GAMs}
library(tidyr)
# Create new data for predictions
newdat <- shannon_with_season_gam %>%
  summarize(Water_Temp_Avg = mean(Water_Temp_Avg, na.rm = TRUE)) %>%
  crossing(
    Secchi.depth = seq(
      min(shannon_with_season_gam$Secchi.depth, na.rm = TRUE),
      max(shannon_with_season_gam$Secchi.depth, na.rm = TRUE),
      length.out = 7
    )
  )

# Predict from your GAM (fitted model)
newdat$pred <- predict(gam_2, newdata = newdat, type = "response")

ggsave(
filename = "Secchi_gam_overlay.png",
plot <- sd_box_plot_month +
  geom_line(
    data = newdat,
    aes(x = Secchi.depth, y = pred),
    inherit.aes = FALSE,
    color = "red",
    linewidth = 1.2
  ) +
  theme(plot.margin = margin(5.5, 5.5, 5.5, 5.5, unit = "pt"))
)
print(plot)

# Create a smooth range of Water_Temp_Avg values
newdat_temp <- shannon_with_season_gam %>%
  summarize(Secchi.depth = mean(Secchi.depth, na.rm = TRUE)) %>%
  crossing(
    Water_Temp_Avg = seq(
      min(shannon_with_season_gam$Water_Temp_Avg, na.rm = TRUE),
      max(shannon_with_season_gam$Water_Temp_Avg, na.rm = TRUE),
      length.out = 7
    )
  )

# Predict from your existing GAM (no refitting!)
newdat_temp$pred <- predict(gam_2, newdata = newdat_temp, type = "response")

ggsave(
filename = "Temp_gam_overlay.png",
plot_temp <- sd_box_plot_month +
  geom_line(
    data = newdat_temp,
    aes(x = Water_Temp_Avg, y = pred),
    color = "blue",
    linewidth = 1.2,
    inherit.aes = FALSE
  ) +
  theme(plot.margin = margin(5.5, 5.5, 5.5, 5.5, unit = "pt"))
)
print(plot_temp)
```